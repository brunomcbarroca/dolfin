version: 2
jobs:
  build:
    docker:
      - image: fenicsproject/pybind11-testing:latest
    working_directory: /home/fenics/working
    steps:
      - run:
          name: Clone DOLFIN
          command: git lfs clone https://bitbucket.org/"${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}".git .
      - checkout
      - run:
          name: Install/update dependencies  # Install with sudo as tests not run as superuser in circleci/python
          command: |
            sudo pip3 install pytest six --upgrade
      - run:
          name: Install pybind11
          command: |
            cd python
            git clone https://github.com/pybind/pybind11.git
            cd pybind11
            mkdir build-dir
            cd build-dir
            cmake -DPYBIND11_TEST=off ../
            sudo make install
      - run:
          name: Build Python interface
          command: |
            cd python
            pip3 -v install . --user
      - run:
          name: Run tests (serial)
          command: python3 -m pytest python/unit-tests
      - run:
          name: Run tests (MPI parallel)
          command: mpirun -n 3 python3 -m pytest python/unit-tests
      - run:
          name: Run tests (reference)
          command: python3 -m pytest test/unit/python/
